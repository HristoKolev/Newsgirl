* find out when to prepare commands

* unify the metadata models between the generator and the shared library.

* test the whole thing
